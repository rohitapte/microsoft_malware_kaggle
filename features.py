import pandas as pd
from sklearn.preprocessing import LabelEncoder
from sklearn.model_selection import train_test_split

DATA_DIR="c:\\USers\\tihor\\Documents\\kaggle\\microsoft_malware\\"

def generate_features_for_ml_algos():
    df_train = pd.read_csv(DATA_DIR + 'train.csv')
    df_test = pd.read_csv(DATA_DIR + 'test.csv')
    test_ids=df_test[['MachineIdentifier']].copy()
    columns = ['Census_IsTouchEnabled',
               'Census_IsSecureBootEnabled',
               'Wdft_IsGamer',
               'Census_PrimaryDiskTypeName',
               'Census_GenuineStateName',
               'Census_OSWUAutoUpdateOptionsName',
               'Census_ActivationChannel',
               'SkuEdition']
    df_labels = df_train['HasDetections'].copy()
    df_train = df_train[columns]
    df_test = df_test[columns]
    df_train['Census_PrimaryDiskTypeName'].fillna('HDD', inplace=True)
    df_train['Wdft_IsGamer'].fillna(0, inplace=True)
    df_test['Census_PrimaryDiskTypeName'].fillna('HDD', inplace=True)
    df_test['Wdft_IsGamer'].fillna(0, inplace=True)
    df_test['Census_GenuineStateName'].fillna('IS_GENUINE', inplace=True)

    columns = ['Census_PrimaryDiskTypeName',
               'Census_GenuineStateName',
               'Census_OSWUAutoUpdateOptionsName',
               'Census_ActivationChannel',
               'SkuEdition']
    #label encoding for categorical
    for col in columns:
        lb = LabelEncoder()
        df_train[col + "_encoded"] = lb.fit_transform(df_train[col])
        df_test[col + "_encoded"] = lb.transform(df_test[col])
    #one hot encoding
    #for col in columns:
    #    df_train=pd.concat([df_train,pd.get_dummies(df_train[col], prefix=col,drop_first=True)],axis=1)
    #    df_test=pd.concat([df_test,pd.get_dummies(df_test[col],prefix=col,drop_first=True)],axis=1)
    #drop unnecessary columns
    df_train.drop(columns=columns, inplace=True, axis=1)
    df_test.drop(columns=columns, inplace=True, axis=1)
    train_x, cv_x, train_labels, cv_labels = train_test_split(df_train, df_labels, test_size=0.1)
    return train_x,cv_x,train_labels,cv_labels,test_ids,df_test

from sklearn.linear_model import LogisticRegression
from sklearn.metrics import roc_auc_score
train_x,cv_x,train_labels,cv_labels,test_ids,x_test=generate_features_for_ml_algos()
clf=LogisticRegression()
clf.fit(train_x,train_labels)
print("Cross validation score %s"%(clf.score(cv_x,cv_labels)))
predicted_cv=clf.predict_proba(cv_x)
print("ROC_AUC score %s"%(roc_auc_score(cv_labels,predicted_cv[:,1])))

predicted=clf.predict_proba(x_test)
test_ids['HasDetections']=predicted[:,1]
test_ids[['MachineIdentifier','HasDetections']].to_csv('logistic_regression2.csv',index=None)