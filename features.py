import pandas as pd
from sklearn.preprocessing import LabelEncoder
from sklearn.model_selection import train_test_split

#DATA_DIR="c:\\USers\\tihor\\Documents\\kaggle\\microsoft_malware\\"
DATA_DIR="d:\\kaggle_data\\microsoft_malware\\"

def generate_features_for_ml_algos():
    columns = ['Census_IsTouchEnabled',
               'Census_IsSecureBootEnabled',
               'Wdft_IsGamer',
               'Census_PrimaryDiskTypeName',
               'Census_GenuineStateName',
               'Census_OSWUAutoUpdateOptionsName',
               'Census_ActivationChannel',
               'SkuEdition']
    print("Loading train dataset...")
    df_train = pd.read_csv(DATA_DIR + 'train.csv')
    df_labels = df_train['HasDetections'].copy()
    df_train = df_train[columns]
    print("Loading train dataset...done")
    print("Loading test dataset...")
    df_test = pd.read_csv(DATA_DIR + 'test.csv')
    test_ids = df_test[['MachineIdentifier']].copy()
    df_test = df_test[columns]
    print("Loading test dataset...done")
    df_train['Census_PrimaryDiskTypeName'].fillna('HDD', inplace=True)
    df_train['Wdft_IsGamer'].fillna(0, inplace=True)
    df_test['Census_PrimaryDiskTypeName'].fillna('HDD', inplace=True)
    df_test['Wdft_IsGamer'].fillna(0, inplace=True)
    df_test['Census_GenuineStateName'].fillna('IS_GENUINE', inplace=True)

    columns = ['Census_PrimaryDiskTypeName',
               'Census_GenuineStateName',
               'Census_OSWUAutoUpdateOptionsName',
               'Census_ActivationChannel',
               'SkuEdition']
    #label encoding for categorical
    #for col in columns:
    #    lb = LabelEncoder()
    #    df_train[col + "_encoded"] = lb.fit_transform(df_train[col])
    #    df_test[col + "_encoded"] = lb.transform(df_test[col])
    #one hot encoding
    for col in columns:
        df_train=pd.concat([df_train,pd.get_dummies(df_train[col], prefix=col,drop_first=True)],axis=1)
        df_test=pd.concat([df_test,pd.get_dummies(df_test[col],prefix=col,drop_first=True)],axis=1)
    #drop unnecessary columns
    df_train.drop(columns=columns, inplace=True, axis=1)
    df_test.drop(columns=columns, inplace=True, axis=1)
    train_x, cv_x, train_labels, cv_labels = train_test_split(df_train, df_labels, test_size=0.1)
    return train_x,cv_x,train_labels,cv_labels,test_ids,df_test
