import pandas as pd
from sklearn.preprocessing import LabelEncoder
from sklearn.model_selection import train_test_split

DATA_DIR="c:\\USers\\tihor\\Documents\\kaggle\\microsoft_malware\\"
#DATA_DIR="d:\\kaggle_data\\microsoft_malware\\"

def generate_features_for_ml_algos(encoding_type='categorical'):
    #columns = ['Census_IsTouchEnabled',
    #           'Census_IsSecureBootEnabled',
    #           'Wdft_IsGamer',
    #           'Census_PrimaryDiskTypeName',
    #           'Census_GenuineStateName',
    #           'Census_OSWUAutoUpdateOptionsName',
    #           'Census_ActivationChannel',
    #           'SkuEdition']
    columns = ['IsBeta', 'IsSxsPassiveMode', 'HasTpm', 'AutoSampleOptIn', 'Census_HasOpticalDiskDrive','Census_IsPortableOperatingSystem','Census_IsSecureBootEnabled','Census_IsTouchEnabled',
               'Census_IsPenCapable','Processor','IsProtected','SMode','Firewall','Census_DeviceFamily','Census_OSArchitecture','Census_IsFlightsDisabled','CountryIdentifier']
    print("Loading train dataset...")
    df_train = pd.read_csv(DATA_DIR + 'train.csv')
    countrySummary = df_train.pivot_table(index='CountryIdentifier', values='HasDetections', aggfunc=['sum', 'count'])
    countrySummary['percent'] = countrySummary.apply(lambda x: round(x['sum'] / x['count'], 2), axis=1)
    df_labels = df_train['HasDetections'].copy()
    df_train = df_train[columns]
    print("Loading train dataset...done")
    print("Loading test dataset...")
    df_test = pd.read_csv(DATA_DIR + 'test.csv')
    test_ids = df_test[['MachineIdentifier']].copy()
    df_test = df_test[columns]
    print("Loading test dataset...done")


    countryList = {}
    temp = countrySummary[countrySummary['percent'] < 0.3]
    countryList['0-30'] = temp.index.tolist()
    temp = countrySummary[countrySummary['percent'] >= 0.3]
    temp = temp[temp['percent'] < 0.35]
    countryList['30-35'] = temp.index.tolist()
    temp = countrySummary[countrySummary['percent'] >= 0.35]
    temp = temp[temp['percent'] < 0.4]
    countryList['35-40'] = temp.index.tolist()
    temp = countrySummary[countrySummary['percent'] >= 0.4]
    temp = temp[temp['percent'] < 0.45]
    countryList['40-45'] = temp.index.tolist()
    temp = countrySummary[countrySummary['percent'] >= 0.45]
    temp = temp[temp['percent'] < 0.5]
    countryList['45-50'] = temp.index.tolist()
    temp = countrySummary[countrySummary['percent'] >= 0.5]
    temp = temp[temp['percent'] < 0.55]
    countryList['50-55'] = temp.index.tolist()
    temp = countrySummary[countrySummary['percent'] >= 0.55]
    temp = temp[temp['percent'] < 0.60]
    countryList['55-60'] = temp.index.tolist()
    temp = countrySummary[countrySummary['percent'] >= 0.6]
    countryList['65-100'] = temp.index.tolist()
    def get_CountryClassification(x):
        for item in countryList:
            if x in countryList[item]:
                return item
        return None

    df_train['CountryCode'] = df_train['CountryIdentifier'].apply(lambda x: get_CountryClassification(x))
    df_test['CountryCode'] = df_test['CountryIdentifier'].apply(lambda x: get_CountryClassification(x))
    df_train.drop(columns=['CountryIdentifier'], inplace=True, axis=1)
    df_test.drop(columns=['CountryIdentifier'], inplace=True, axis=1)

    df_train['IsProtected'].fillna(1.0,inplace=True)
    df_test['IsProtected'].fillna(1.0, inplace=True)
    df_train['SMode'].fillna(0.0, inplace=True)
    df_test['SMode'].fillna(0.0, inplace=True)
    df_train['Firewall'].fillna(1.0, inplace=True)
    df_test['Firewall'].fillna(1.0, inplace=True)
    df_train['Census_IsFlightsDisabled'].fillna(0.0, inplace=True)
    df_test['Census_IsFlightsDisabled'].fillna(0.0, inplace=True)
    #df_train['Census_PrimaryDiskTypeName'].fillna('HDD', inplace=True)
    #df_train['Wdft_IsGamer'].fillna(0, inplace=True)
    #df_test['Census_PrimaryDiskTypeName'].fillna('HDD', inplace=True)
    #df_test['Wdft_IsGamer'].fillna(0, inplace=True)
    #df_test['Census_GenuineStateName'].fillna('IS_GENUINE', inplace=True)

    #columns = ['Census_PrimaryDiskTypeName',
    #           'Census_GenuineStateName',
    #           'Census_OSWUAutoUpdateOptionsName',
    #           'Census_ActivationChannel',
    #           'SkuEdition']
    columns=['Processor','Census_DeviceFamily','Census_OSArchitecture','CountryCode']
    if encoding_type=='categorical':
        print("Using categorical encoding")
        #label encoding for categorical
        for col in columns:
            lb = LabelEncoder()
            df_train[col + "_encoded"] = lb.fit_transform(df_train[col])
            df_test[col + "_encoded"] = lb.transform(df_test[col])
    else:
        print("Using one hot encoding")
        #one hot encoding
        for col in columns:
            df_train=pd.concat([df_train,pd.get_dummies(df_train[col], prefix=col,drop_first=True)],axis=1)
            df_test=pd.concat([df_test,pd.get_dummies(df_test[col],prefix=col,drop_first=True)],axis=1)
    #drop unnecessary columns
    df_train.drop(columns=columns, inplace=True, axis=1)
    print(df_train.columns)
    df_test.drop(columns=columns, inplace=True, axis=1)
    print(df_test.columns)
    train_x, cv_x, train_labels, cv_labels = train_test_split(df_train, df_labels, test_size=0.1)
    return train_x,cv_x,train_labels,cv_labels,test_ids,df_test
